ARG ONEAPI_VERSION=2025.1.3-0
ARG VLLM_VERSION=2176778cd

FROM intel/deep-learning-essentials:${ONEAPI_VERSION}-devel-ubuntu24.04 AS vllm-base

ARG CACHE_BUSTER
RUN if [ -n "${CACHE_BUSTER}" ]; then \
        echo "$CACHE_BUSTER" > /tmp/builder-buster; \
    fi;

RUN wget -O- https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB | gpg --dearmor | tee /usr/share/keyrings/oneapi-archive-keyring.gpg > /dev/null && \
    echo "deb [signed-by=/usr/share/keyrings/oneapi-archive-keyring.gpg] https://apt.repos.intel.com/oneapi all main" | tee /etc/apt/sources.list.d/oneAPI.list && \
    add-apt-repository -y ppa:kobuk-team/intel-graphics

RUN apt clean && apt-get update -y && \
    apt-get install -y --no-install-recommends --fix-missing \
    curl \
    ffmpeg \
    git \
    libsndfile1 \
    libsm6 \
    libxext6 \
    libgl1 \
    lsb-release \
    numactl \
    wget \
    vim \
    python3.12 \
    python3.12-dev \
    python3-pip

RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1
RUN update-alternatives --install /usr/bin/python python /usr/bin/python3.12 1

RUN apt install -y libze1 libze-dev libze-intel-gpu1 intel-opencl-icd libze-intel-gpu-raytracing

# Install UCX build dependencies and RDMA packages
RUN apt-get install -y --no-install-recommends \
    autoconf \
    automake \
    libtool \
    pkg-config \
    libibverbs-dev \
    libibverbs1 \
    librdmacm-dev \
    librdmacm1 \
    rdma-core \
    ibverbs-utils \
    rdmacm-utils \
    libnuma-dev \
    libaio-dev

# Build and install UCX from source with Level Zero (ze) support
# Using git master to get the latest fixes for ze_copy compilation
ENV UCX_HOME=/opt/ucx

RUN cd /tmp && \
    git clone --depth 1 https://github.com/openucx/ucx.git ucx-src && \
    cd ucx-src && \
    ./autogen.sh && \
    CFLAGS="-Wno-error=incompatible-pointer-types" ./contrib/configure-release \
        --prefix=${UCX_HOME} \
        --with-ze=/usr \
        --enable-shared \
        --disable-static \
        --disable-doxygen-doc \
        --enable-optimizations \
        --enable-cma \
        --enable-devel-headers \
        --enable-mt \
        --with-verbs \
        --with-rdmacm \
        --with-dm && \
    CFLAGS="-Wno-error=incompatible-pointer-types" make -j$(nproc) && \
    make install-strip && \
    rm -rf /tmp/ucx-src

ENV PATH=${UCX_HOME}/bin:${PATH}
ENV LD_LIBRARY_PATH=${UCX_HOME}/lib:${LD_LIBRARY_PATH}
ENV CPATH=${UCX_HOME}/include:${CPATH}
ENV LIBRARY_PATH=${UCX_HOME}/lib:${LIBRARY_PATH}
ENV PKG_CONFIG_PATH=${UCX_HOME}/lib/pkgconfig:${PKG_CONFIG_PATH}

RUN wget https://github.com/uxlfoundation/oneCCL/releases/download/2021.15.4/intel-oneccl-2021.15.4.11_offline.sh
RUN bash intel-oneccl-2021.15.4.11_offline.sh -a --silent --eula accept && echo "source /opt/intel/oneapi/setvars.sh --force" >> /root/.bashrc
SHELL ["bash", "-c"]
CMD ["bash", "-c", "source /root/.bashrc && exec bash"]

# Clone vLLM and build for XPU
WORKDIR /workspace
RUN git clone https://github.com/vllm-project/vllm.git && \
    cd vllm && \
    git checkout ${VLLM_VERSION}


WORKDIR /workspace/vllm

# suppress the python externally managed environment error
RUN python3 -m pip config set global.break-system-packages true

RUN pip install --no-cache-dir \
    -r requirements/xpu.txt

ENV LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/usr/local/lib/"

ENV VLLM_TARGET_DEVICE=xpu
ENV VLLM_WORKER_MULTIPROC_METHOD=spawn

RUN pip install -v .

CMD ["/bin/bash"]

FROM vllm-base AS runtime

# install additional dependencies for openai api server
RUN pip install accelerate hf_transfer pytest pytest_asyncio lm_eval[api] modelscope

RUN pip uninstall oneccl oneccl-devel -y

# install development dependencies (for testing)
RUN python3 -m pip install -e tests/vllm_test_utils

# Patch the NIXL install script to enable Level Zero (ze) support in UCX
# and fix the -Werror compilation issue, and ensure RDMA support
RUN if [ -f /workspace/vllm/tools/install_nixl_from_source_ubuntu.py ]; then \
        # Enable Level Zero support\
        sed -i 's/--with-ze=no/--with-ze=\/usr/g' /workspace/vllm/tools/install_nixl_from_source_ubuntu.py && \
        # Add --with-rdmacm for RDMA connection manager support after --with-verbs\
        sed -i 's/"--with-verbs",/"--with-verbs",\n        "--with-rdmacm",/g' /workspace/vllm/tools/install_nixl_from_source_ubuntu.py && \
        # Ensure libibverbs-dev and librdmacm-dev are in apt packages\
        sed -i 's/"libtool-bin",/"libtool-bin",\n        "libibverbs-dev",\n        "librdmacm-dev",\n        "rdma-core",/g' /workspace/vllm/tools/install_nixl_from_source_ubuntu.py && \
        echo "Patched NIXL install script to enable Level Zero and RDMA support"; \
        cat /workspace/vllm/tools/install_nixl_from_source_ubuntu.py | grep -A15 "configure_command ="; \
    fi

# install nixl from source code (now with ze and RDMA support)
RUN if [ -f /workspace/vllm/tools/install_nixl_from_source_ubuntu.py ]; then \
        CFLAGS="-Wno-error=incompatible-pointer-types" python3 /workspace/vllm/tools/install_nixl_from_source_ubuntu.py --force-reinstall; \
    else \
        echo "ERROR: /workspace/vllm/tools/install_nixl_from_source_ubuntu.py not found!" >&2; \
        exit 1; \
    fi
ENV LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/usr/local/lib/python3.12/dist-packages/.nixl.mesonpy.libs/plugins/"

# Set UCX transport to use InfiniBand, RC, and Level Zero copy
ENV UCX_TLS="ib,rc,ze_copy,tcp,sm,self"
ENV UCX_LOG_LEVEL="info"

ENTRYPOINT ["python", "-m", "vllm.entrypoints.openai.api_server"]
